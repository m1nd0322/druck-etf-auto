{% extends "base.html" %}
{% set active = "dashboard" %}

{% block title %}Dashboard - Druck ETF Auto{% endblock %}

{% block content %}
<div class="dashboard">
  <div class="header-row">
    <h1>ETF Allocation Dashboard</h1>
    <button id="btn-run" class="btn btn-primary" onclick="runReport()">
      <span id="btn-text">Run Report</span>
      <span id="btn-spinner" class="spinner" style="display:none"></span>
    </button>
  </div>

  <div id="error-box" class="alert alert-error" style="display:none"></div>

  {% if latest %}
  <div id="result-section">
    {% include "_result.html" %}
  </div>
  {% else %}
  <div id="result-section" class="empty-state">
    <p>No report generated yet. Click <strong>Run Report</strong> to analyze the current market.</p>
  </div>
  {% endif %}

  {% if reports %}
  <section class="section">
    <h2>Recent Reports</h2>
    <div class="report-list">
      {% for r in reports[:5] %}
      <a href="/report/{{ r.filename }}" class="report-card">
        <span class="report-date">{{ r.label }}</span>
        <span class="report-file">{{ r.filename }}</span>
      </a>
      {% endfor %}
      {% if reports|length > 5 %}
      <a href="/history" class="btn btn-secondary">View all</a>
      {% endif %}
    </div>
  </section>
  {% endif %}
</div>

<script>
async function runReport() {
  const btn = document.getElementById('btn-run');
  const btnText = document.getElementById('btn-text');
  const spinner = document.getElementById('btn-spinner');
  const errorBox = document.getElementById('error-box');
  const resultSection = document.getElementById('result-section');

  btn.disabled = true;
  btnText.textContent = 'Analyzing...';
  spinner.style.display = 'inline-block';
  errorBox.style.display = 'none';

  try {
    const resp = await fetch('/api/run', { method: 'POST' });
    const body = await resp.json();
    if (!body.ok) {
      throw new Error(body.error || 'Unknown error');
    }
    // Reload page to show updated result
    window.location.reload();
  } catch (err) {
    errorBox.textContent = err.message;
    errorBox.style.display = 'block';
  } finally {
    btn.disabled = false;
    btnText.textContent = 'Run Report';
    spinner.style.display = 'none';
  }
}
</script>
{% endblock %}
